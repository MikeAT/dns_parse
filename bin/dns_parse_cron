#!/usr/bin/python
from ConfigParser import SafeConfigParser
import glob
import fcntl
import os
import subprocess
import sys

CFG_PATH = '/etc/dns_parse.cfg'
CFG_OPTIONS = ['PCAP_DIR', 'NETWORKS', 'STATE_DIR', 'OPTIONS', 
               'LOG_FILE', 'ERROR_LOG']
parser = SafeConfigParser()
parser.read(CFG_PATH)

options = {'OPTIONS':''}
for option in CFG_OPTIONS:
    if parser.has_option('DEFAULT', option):
        options[option] = parser.get('DEFAULT', option)

    if option not in options:
        print "You must set a value for option '%s' in %s" % (option, CFG_PATH)
        sys.exit(-1)

for network in options['NETWORK']:
    state_fn = os.path.join(options['STATE_DIR'], network)
    if os.path.exists(state_fn):
        statefile = open(state_fn)
        last = statefile.read()
    else:
        statefile = open(state_fn, 'a')
        last = None

    try:
        fcntl.flock(statefile, fcntl.LOCK_EX | fcntl.LOCK_NB)

        path = os.path.join(options['PCAP_DIR'], network) + '.*.gz'
        files = glob.glob(path)
        files.sort(reverse=True)
        if not files:
            continue
        
        if (last not in files):
            i = 0
        else:
            i = files.index(last) - 1

        while i >= 0:
            path = os.path.join(PCAP_DIR, files[i])
            cmd = 'gunzip -c %s | /usr/local/sbin/dns_parse %s - >> %s 2>> %s'%\
                  (path, options['OPTIONS'], options['LOG_FILE'], 
                   options['ERROR_LOG'])
            subprocess.call(cmd, shell=True)
            i = i - 1

        if not os.path.exists(options['STATE_DIR']):
            subprocess.call(['mkdir', '-p', options['STATE_DIR']])
        wstatefile = open(state_fn, 'w')
        wstatefile.write(files[0])
        wstatefile.close()
    finally:
        fcntl.flock(statefile, fcntl.LOCK_UN)
        statefile.close()

